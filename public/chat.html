<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSU Chat - Otaqlar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 15px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        .header-subtitle {
            font-size: 13px;
            color: #666;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-logout {
            background: #dc3545;
            color: white;
        }

        .btn-logout:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-rules {
            background: #6c757d;
            color: white;
            margin-right: 10px;
        }

        .btn-rules:hover {
            background: #5a6268;
        }

        .daily-topic {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 15px;
            color: #856404;
            font-weight: 500;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .faculties-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .faculty-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .faculty-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .faculty-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .faculty-name {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .faculty-subtitle {
            font-size: 12px;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 600;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: all 0.3s;
        }

        .modal-close:hover {
            color: #333;
            transform: rotate(90deg);
        }

        .profile-section {
            text-align: center;
            margin-bottom: 25px;
        }

        .profile-picture-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 15px;
        }

        .profile-picture {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            font-weight: 600;
            margin: 0 auto;
            border: 5px solid #f0f0f0;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .profile-picture img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .upload-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 35px;
            height: 35px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .upload-btn:hover {
            background: #764ba2;
            transform: scale(1.1);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-size: 13px;
            font-weight: 500;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            background: #f8f9fa;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }

        .btn-save {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .rules-content {
            white-space: pre-wrap;
            line-height: 1.8;
            color: #555;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .faculties-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div style="font-size: 35px;">üéì</div>
            <div>
                <div class="header-title">BSU Chat</div>
                <div class="header-subtitle" id="welcomeText"></div>
            </div>
        </div>
        <div class="user-info">
            <button class="btn btn-rules" onclick="showRules()">üìã Qaydalar</button>
            <div class="user-avatar" onclick="showProfile()" id="userAvatar"></div>
            <button class="btn btn-logout" onclick="logout()">√áƒ±xƒ±≈ü</button>
        </div>
    </div>

    <div class="daily-topic" id="dailyTopic">
        ‚≠ê G√ºn m√∂vzusu y√ºkl…ônir...
    </div>

    <div class="faculties-grid" id="facultiesGrid"></div>

    <!-- Profil Modal -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Profil Ayarlarƒ±</h2>
                <button class="modal-close" onclick="closeProfile()">&times;</button>
            </div>
            
            <div class="profile-section">
                <div class="profile-picture-wrapper">
                    <div class="profile-picture" id="modalProfilePicture"></div>
                    <label for="profilePictureInput" class="upload-btn">üì∑</label>
                    <input type="file" id="profilePictureInput" accept="image/*" style="display: none;" onchange="uploadProfilePicture()">
                </div>
            </div>

            <div class="input-group">
                <label>Ad v…ô Soyad</label>
                <input type="text" id="profileFullname">
            </div>

            <div class="input-group">
                <label>Fak√ºlt…ô</label>
                <select id="profileFaculty">
                    <option value="Mexanika-riyaziyyat fak√ºlt…ôsi">Mexanika-riyaziyyat fak√ºlt…ôsi</option>
                    <option value="T…ôtbiqi riyaziyyat v…ô kibernetika fak√ºlt…ôsi">T…ôtbiqi riyaziyyat v…ô kibernetika fak√ºlt…ôsi</option>
                    <option value="Fizika fak√ºlt…ôsi">Fizika fak√ºlt…ôsi</option>
                    <option value="Kimya fak√ºlt…ôsi">Kimya fak√ºlt…ôsi</option>
                    <option value="Biologiya fak√ºlt…ôsi">Biologiya fak√ºlt…ôsi</option>
                    <option value="Ekologiya v…ô torpaq≈ü√ºnaslƒ±q fak√ºlt…ôsi">Ekologiya v…ô torpaq≈ü√ºnaslƒ±q fak√ºlt…ôsi</option>
                    <option value="Coƒürafiya fak√ºlt…ôsi">Coƒürafiya fak√ºlt…ôsi</option>
                    <option value="Geologiya fak√ºlt…ôsi">Geologiya fak√ºlt…ôsi</option>
                    <option value="Filologiya fak√ºlt…ôsi">Filologiya fak√ºlt…ôsi</option>
                    <option value="Tarix fak√ºlt…ôsi">Tarix fak√ºlt…ôsi</option>
                    <option value="Beyn…ôlxalq m√ºnasib…ôtl…ôr v…ô iqtisadiyyat fak√ºlt…ôsi">Beyn…ôlxalq m√ºnasib…ôtl…ôr v…ô iqtisadiyyat fak√ºlt…ôsi</option>
                    <option value="H√ºquq fak√ºlt…ôsi">H√ºquq fak√ºlt…ôsi</option>
                    <option value="Jurnalistika fak√ºlt…ôsi">Jurnalistika fak√ºlt…ôsi</option>
                    <option value="ƒ∞nformasiya v…ô s…ôn…ôd menecmenti fak√ºlt…ôsi">ƒ∞nformasiya v…ô s…ôn…ôd menecmenti fak√ºlt…ôsi</option>
                    <option value="≈û…ôrq≈ü√ºnaslƒ±q fak√ºlt…ôsi">≈û…ôrq≈ü√ºnaslƒ±q fak√ºlt…ôsi</option>
                    <option value="Sosial elml…ôr v…ô psixologiya fak√ºlt…ôsi">Sosial elml…ôr v…ô psixologiya fak√ºlt…ôsi</option>
                </select>
            </div>

            <div class="input-group">
                <label>D…ôr…ôc…ô</label>
                <select id="profileDegree">
                    <option value="Bakalavr">Bakalavr</option>
                    <option value="Magistr">Magistr</option>
                    <option value="Doktorantura">Doktorantura</option>
                </select>
            </div>

            <div class="input-group">
                <label>Kurs</label>
                <select id="profileCourse">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                </select>
            </div>

            <button class="btn btn-save" onclick="saveProfile()">Yadda saxla</button>
        </div>
    </div>

    <!-- Qaydalar Modal -->
    <div class="modal" id="rulesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Qaydalar</h2>
                <button class="modal-close" onclick="closeRules()">&times;</button>
            </div>
            <div class="rules-content" id="rulesContent"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) {
            window.location.href = '/';
        }

        const facultyIcons = {
            "Mexanika-riyaziyyat fak√ºlt…ôsi": "üî¢",
            "T…ôtbiqi riyaziyyat v…ô kibernetika fak√ºlt…ôsi": "üíª",
            "Fizika fak√ºlt…ôsi": "‚öõÔ∏è",
            "Kimya fak√ºlt…ôsi": "üß™",
            "Biologiya fak√ºlt…ôsi": "üß¨",
            "Ekologiya v…ô torpaq≈ü√ºnaslƒ±q fak√ºlt…ôsi": "üå±",
            "Coƒürafiya fak√ºlt…ôsi": "üó∫Ô∏è",
            "Geologiya fak√ºlt…ôsi": "ü™®",
            "Filologiya fak√ºlt…ôsi": "üìö",
            "Tarix fak√ºlt…ôsi": "üìú",
            "Beyn…ôlxalq m√ºnasib…ôtl…ôr v…ô iqtisadiyyat fak√ºlt…ôsi": "üåê",
            "H√ºquq fak√ºlt…ôsi": "‚öñÔ∏è",
            "Jurnalistika fak√ºlt…ôsi": "üì∞",
            "ƒ∞nformasiya v…ô s…ôn…ôd menecmenti fak√ºlt…ôsi": "üìã",
            "≈û…ôrq≈ü√ºnaslƒ±q fak√ºlt…ôsi": "üïå",
            "Sosial elml…ôr v…ô psixologiya fak√ºlt…ôsi": "üß†"
        };

        const faculties = [
            "Mexanika-riyaziyyat fak√ºlt…ôsi",
            "T…ôtbiqi riyaziyyat v…ô kibernetika fak√ºlt…ôsi",
            "Fizika fak√ºlt…ôsi",
            "Kimya fak√ºlt…ôsi",
            "Biologiya fak√ºlt…ôsi",
            "Ekologiya v…ô torpaq≈ü√ºnaslƒ±q fak√ºlt…ôsi",
            "Coƒürafiya fak√ºlt…ôsi",
            "Geologiya fak√ºlt…ôsi",
            "Filologiya fak√ºlt…ôsi",
            "Tarix fak√ºlt…ôsi",
            "Beyn…ôlxalq m√ºnasib…ôtl…ôr v…ô iqtisadiyyat fak√ºlt…ôsi",
            "H√ºquq fak√ºlt…ôsi",
            "Jurnalistika fak√ºlt…ôsi",
            "ƒ∞nformasiya v…ô s…ôn…ôd menecmenti fak√ºlt…ôsi",
            "≈û…ôrq≈ü√ºnaslƒ±q fak√ºlt…ôsi",
            "Sosial elml…ôr v…ô psixologiya fak√ºlt…ôsi"
        ];

        // ƒ∞stifad…ô√ßi m…ôlumatlarƒ±nƒ± g√∂st…ôr
        document.getElementById('welcomeText').textContent = `Xo≈ü g…ôldin, ${currentUser.fullname}`;
        
        // Avatar
        const userAvatar = document.getElementById('userAvatar');
        if (currentUser.profile_picture) {
            userAvatar.innerHTML = `<img src="${currentUser.profile_picture}" alt="Profile">`;
        } else {
            userAvatar.textContent = currentUser.fullname.charAt(0).toUpperCase();
        }

        // Fak√ºlt…ôl…ôri g√∂st…ôr
        const facultiesGrid = document.getElementById('facultiesGrid');
        faculties.forEach(faculty => {
            const card = document.createElement('div');
            card.className = 'faculty-card';
            card.onclick = () => openFacultyChat(faculty);
            card.innerHTML = `
                <div class="faculty-icon">${facultyIcons[faculty]}</div>
                <div class="faculty-name">${faculty}</div>
                <div class="faculty-subtitle">Chat otaƒüƒ±</div>
            `;
            facultiesGrid.appendChild(card);
        });

        // G√ºn√ºn m√∂vzusunu y√ºkl…ô
        fetch('/api/daily-topic')
            .then(res => res.json())
            .then(data => {
                document.getElementById('dailyTopic').textContent = `‚≠ê ${data.topic}`;
            });

        // Socket.IO baƒülantƒ±sƒ±
        const socket = io();

        socket.on('daily-topic-updated', (data) => {
            document.getElementById('dailyTopic').textContent = `‚≠ê ${data.topic}`;
        });

        function openFacultyChat(faculty) {
            localStorage.setItem('selectedFaculty', faculty);
            window.location.href = '/room.html';
        }

        function showProfile() {
            document.getElementById('profileModal').classList.add('active');
            document.getElementById('profileFullname').value = currentUser.fullname;
            document.getElementById('profileFaculty').value = currentUser.faculty;
            document.getElementById('profileDegree').value = currentUser.degree;
            document.getElementById('profileCourse').value = currentUser.course;
            
            const modalPicture = document.getElementById('modalProfilePicture');
            if (currentUser.profile_picture) {
                modalPicture.innerHTML = `<img src="${currentUser.profile_picture}" alt="Profile">`;
            } else {
                modalPicture.textContent = currentUser.fullname.charAt(0).toUpperCase();
            }
        }

        function closeProfile() {
            document.getElementById('profileModal').classList.remove('active');
        }

        async function uploadProfilePicture() {
            const fileInput = document.getElementById('profilePictureInput');
            const file = fileInput.files[0];
            
            if (!file) return;

            const formData = new FormData();
            formData.append('profile_picture', file);
            formData.append('userId', currentUser.id);

            try {
                const response = await fetch('/api/upload-profile-picture', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (data.success) {
                    currentUser.profile_picture = data.filePath;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // Update UI
                    document.getElementById('userAvatar').innerHTML = `<img src="${data.filePath}" alt="Profile">`;
                    document.getElementById('modalProfilePicture').innerHTML = `<img src="${data.filePath}" alt="Profile">`;
                    
                    alert('Profil ≈ü…ôkli y√ºkl…ôndi!');
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('≈û…ôkil y√ºkl…ôn…ôrk…ôn x…ôta ba≈ü verdi');
            }
        }

        async function saveProfile() {
            const fullname = document.getElementById('profileFullname').value;
            const faculty = document.getElementById('profileFaculty').value;
            const degree = document.getElementById('profileDegree').value;
            const course = document.getElementById('profileCourse').value;

            try {
                const response = await fetch('/api/update-profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        fullname,
                        faculty,
                        degree,
                        course
                    })
                });

                const data = await response.json();
                if (data.success) {
                    currentUser.fullname = fullname;
                    currentUser.faculty = faculty;
                    currentUser.degree = degree;
                    currentUser.course = course;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    document.getElementById('welcomeText').textContent = `Xo≈ü g…ôldin, ${fullname}`;
                    document.getElementById('userAvatar').textContent = fullname.charAt(0).toUpperCase();
                    
                    alert('Profil yenil…ôndi!');
                    closeProfile();
                }
            } catch (error) {
                console.error('Update error:', error);
                alert('Profil yenil…ôm…ô zamanƒ± x…ôta ba≈ü verdi');
            }
        }

        function showRules() {
            fetch('/api/rules')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('rulesContent').textContent = data.content;
                    document.getElementById('rulesModal').classList.add('active');
                });
        }

        function closeRules() {
            document.getElementById('rulesModal').classList.remove('active');
        }

        function logout() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('selectedFaculty');
            window.location.href = '/';
        }
    </script>
</body>
</html>
